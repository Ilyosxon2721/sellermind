# /review - Code Review

Проверка качества кода перед коммитом или деплоем.

## Использование

```
/review                    # Проверить все изменения (git diff)
/review app/Services/      # Проверить конкретную папку
/review ProductService.php # Проверить конкретный файл
/review --full             # Полный аудит всего проекта
```

---

## Что проверяется

### 🔴 Критичное (BLOCKED)
Код НЕ ДОЛЖЕН быть закоммичен пока не исправлено:

| Проблема | Пример |
|----------|--------|
| SQL инъекции | `DB::select("SELECT * FROM users WHERE id = $id")` |
| XSS уязвимости | `{!! $userInput !!}` без санитизации |
| Hardcoded секреты | `$apiKey = "sk-12345..."` |
| N+1 запросы | Цикл с запросами без eager loading |
| Отсутствие валидации | Данные из request без проверки |
| Небезопасное удаление | `unlink($userProvidedPath)` |

### 🟡 Важное (WARNING)
Желательно исправить:

| Проблема | Рекомендация |
|----------|--------------|
| Нет type hints | Добавить типы параметров и return |
| Длинные методы | Разбить на < 20 строк |
| Дублирование | Вынести в отдельный метод/сервис |
| Нет тестов | Добавить хотя бы один тест |
| Magic numbers | Вынести в константы |
| Сложные условия | Упростить или вынести в методы |

### 🟢 Рекомендации (SUGGESTION)
Можно улучшить:

| Проблема | Рекомендация |
|----------|--------------|
| Неудачные названия | Более описательные имена |
| Отсутствие комментариев | Добавить PHPDoc |
| Форматирование | Запустить Pint |
| Устаревший синтаксис | Использовать современный PHP |

---

## Чеклисты по типам файлов

### Controllers
```
□ Тонкий контроллер (логика в сервисах)
□ Form Request для валидации
□ Resource для API ответов
□ Правильные HTTP статусы
□ Авторизация (Policy/Gate)
```

### Services
```
□ Single Responsibility
□ Dependency Injection
□ Type hints везде
□ Обработка ошибок
□ Логирование важных действий
```

### Models
```
□ Fillable/Guarded определены
□ Relationships правильные
□ Casts для типов
□ Scopes для частых запросов
□ Нет бизнес-логики (только данные)
```

### Blade Views
```
□ Экранирование: {{ }} вместо {!! !!}
□ @csrf в формах
□ Компоненты для переиспользования
□ Нет PHP логики (только отображение)
```

### Migrations
```
□ Есть down() метод
□ Индексы на foreign keys
□ Правильные типы колонок
□ Nullable где нужно
```

---

## Формат вывода

```
══════════════════════════════════════════════════════════
📋 CODE REVIEW REPORT
══════════════════════════════════════════════════════════

📁 Проверено файлов: 5
⏱️ Время: 2.3 сек

──────────────────────────────────────────────────────────
🔴 CRITICAL (2 issues) — НЕОБХОДИМО ИСПРАВИТЬ
──────────────────────────────────────────────────────────

1. app/Http/Controllers/ProductController.php:45
   ❌ SQL Injection vulnerability
   
   Проблема:
   > $products = DB::select("SELECT * FROM products WHERE name = '$name'");
   
   Решение:
   > $products = DB::select("SELECT * FROM products WHERE name = ?", [$name]);

2. resources/views/product.blade.php:23
   ❌ XSS vulnerability
   
   Проблема:
   > {!! $product->description !!}
   
   Решение:
   > {{ $product->description }}
   > // или если нужен HTML: {!! clean($product->description) !!}

──────────────────────────────────────────────────────────
🟡 WARNINGS (3 issues) — РЕКОМЕНДУЕТСЯ ИСПРАВИТЬ
──────────────────────────────────────────────────────────

1. app/Services/ProductService.php:67
   ⚠️ Method too long (45 lines)
   Рекомендация: Разбить на несколько методов

2. app/Models/Product.php:34
   ⚠️ N+1 Query potential
   > foreach ($products as $product) { $product->category->name }
   Рекомендация: Product::with('category')->get()

3. app/Services/AnalyticsService.php
   ⚠️ No tests found
   Рекомендация: Добавить unit тесты

──────────────────────────────────────────────────────────
🟢 SUGGESTIONS (4 items) — МОЖНО УЛУЧШИТЬ
──────────────────────────────────────────────────────────

1. Переименовать $d → $data (более описательно)
2. Добавить PHPDoc к публичным методам
3. Использовать str() хелпер вместо Str::
4. Вынести magic number 30 в константу DAYS_THRESHOLD

══════════════════════════════════════════════════════════
📊 SUMMARY
══════════════════════════════════════════════════════════

Critical:    2  🔴
Warnings:    3  🟡
Suggestions: 4  🟢

Status: ❌ BLOCKED — исправь critical issues перед коммитом
══════════════════════════════════════════════════════════
```

---

## Автоматический review в hooks

Review автоматически запускается:
- Перед `git commit` (если настроен pre-commit hook)
- После `/implement` команды
- В `/autopilot` режиме перед каждым коммитом
