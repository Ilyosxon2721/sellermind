#!/bin/bash

# ================================
# –°–ö–†–ò–ü–¢ –ù–ê–°–¢–†–û–ô–ö–ò SYMLINK –î–õ–Ø cPanel
# ================================
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: bash setup-symlink.sh
# –í—ã–ø–æ–ª–Ω—è—Ç—å —á–µ—Ä–µ–∑ SSH –ø–æ—Å–ª–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

echo "üîó –ù–∞—Å—Ç—Ä–æ–π–∫–∞ symlink –¥–ª—è public_html..."

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç–∏
HOME_DIR="$HOME"
PUBLIC_HTML="$HOME_DIR/public_html"
PROJECT_PUBLIC="$HOME_DIR/sellermind-ai/public"

echo "–î–æ–º–∞—à–Ω—è—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $HOME_DIR"
echo "Public HTML: $PUBLIC_HTML"
echo "Laravel Public: $PROJECT_PUBLIC"

# ================================
# 1. –ü–†–û–í–ï–†–ö–ê –°–£–©–ï–°–¢–í–û–í–ê–ù–ò–Ø –ü–†–û–ï–ö–¢–ê
# ================================
echo -e "${YELLOW}[1/4] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞...${NC}"

if [ ! -d "$PROJECT_PUBLIC" ]; then
    echo -e "${RED}‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è $PROJECT_PUBLIC –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!${NC}"
    echo "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–æ–µ–∫—Ç –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ $HOME_DIR/sellermind-ai"
    exit 1
fi

echo -e "${GREEN}‚úì –ü—Ä–æ–µ–∫—Ç –Ω–∞–π–¥–µ–Ω${NC}"

# ================================
# 2. –†–ï–ó–ï–†–í–ù–û–ï –ö–û–ü–ò–†–û–í–ê–ù–ò–ï PUBLIC_HTML
# ================================
echo -e "${YELLOW}[2/4] –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ public_html...${NC}"

if [ -e "$PUBLIC_HTML" ] && [ ! -L "$PUBLIC_HTML" ]; then
    # –ï—Å–ª–∏ public_html —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ —ç—Ç–æ –Ω–µ —Å–∏–º–ª–∏–Ω–∫
    BACKUP_DIR="$HOME_DIR/public_html_backup_$(date +%Y%m%d_%H%M%S)"
    echo "–°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –≤ $BACKUP_DIR"
    mv "$PUBLIC_HTML" "$BACKUP_DIR"
    echo -e "${GREEN}‚úì –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞${NC}"
elif [ -L "$PUBLIC_HTML" ]; then
    # –ï—Å–ª–∏ public_html —É–∂–µ —Å–∏–º–ª–∏–Ω–∫
    echo "public_html —É–∂–µ —è–≤–ª—è–µ—Ç—Å—è —Å–∏–º–ª–∏–Ω–∫–æ–º, —É–¥–∞–ª—è–µ–º..."
    rm "$PUBLIC_HTML"
    echo -e "${GREEN}‚úì –°—Ç–∞—Ä—ã–π —Å–∏–º–ª–∏–Ω–∫ —É–¥–∞–ª–µ–Ω${NC}"
else
    echo -e "${GREEN}‚úì public_html –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ${NC}"
fi

# ================================
# 3. –°–û–ó–î–ê–ù–ò–ï SYMLINK
# ================================
echo -e "${YELLOW}[3/4] –°–æ–∑–¥–∞–Ω–∏–µ symlink...${NC}"

ln -s "$PROJECT_PUBLIC" "$PUBLIC_HTML"
echo -e "${GREEN}‚úì Symlink —Å–æ–∑–¥–∞–Ω${NC}"

# ================================
# 4. –ü–†–û–í–ï–†–ö–ê SYMLINK
# ================================
echo -e "${YELLOW}[4/4] –ü—Ä–æ–≤–µ—Ä–∫–∞ symlink...${NC}"

if [ -L "$PUBLIC_HTML" ] && [ -e "$PUBLIC_HTML" ]; then
    TARGET=$(readlink -f "$PUBLIC_HTML")
    echo "Symlink —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞: $TARGET"
    
    if [ -f "$PUBLIC_HTML/index.php" ]; then
        echo -e "${GREEN}‚úì index.php –Ω–∞–π–¥–µ–Ω${NC}"
        echo -e "${GREEN}‚úì Symlink –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ!${NC}"
    else
        echo -e "${RED}‚ùå index.php –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ public_html${NC}"
        exit 1
    fi
else
    echo -e "${RED}‚ùå Symlink –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç${NC}"
    exit 1
fi

echo ""
echo -e "${GREEN}‚úÖ –ù–ê–°–¢–†–û–ô–ö–ê SYMLINK –ó–ê–í–ï–†–®–ï–ù–ê!${NC}"
echo ""
echo "üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "1. –û—Ç–∫—Ä–æ–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä –∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∞—à –¥–æ–º–µ–Ω"
echo "2. –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ Laravel —Å—Ç—Ä–∞–Ω–∏—Ü—É - –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç!"
echo "3. –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ 403/404 - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞"
echo ""
