<!DOCTYPE html>
<html>
<head>
    <title>–¢–µ—Å—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ WB</title>
    <style>
        body {
            font-family: sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
        }
        .section {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        h2 {
            margin-top: 0;
            color: #1f2937;
        }
        button {
            padding: 12px 24px;
            margin: 10px 10px 10px 0;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        button:hover {
            background: #1d4ed8;
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #fff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.6s linear infinite;
            margin-right: 8px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        pre {
            background: #f9fafb;
            padding: 15px;
            overflow-x: auto;
            border-radius: 6px;
            font-size: 13px;
        }
        .error {
            background: #fee;
            color: #c00;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .success {
            background: #d1fae5;
            color: #065f46;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .info {
            background: #dbeafe;
            color: #1e40af;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        input {
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            width: 100px;
            font-size: 14px;
        }
        label {
            display: inline-block;
            margin-right: 10px;
            color: #374151;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <h1>üîÑ –¢–µ—Å—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ Wildberries</h1>

    <div class="section">
        <h2>–®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</h2>
        <button onclick="checkAuth()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω</button>
        <div id="auth-result"></div>
    </div>

    <div class="section">
        <h2>–®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞ WB</h2>
        <label>Account ID:</label>
        <input type="number" id="accountId" value="2">
        <button onclick="checkAccount()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
        <div id="account-result"></div>
    </div>

    <div class="section">
        <h2>–®–∞–≥ 3: –ó–∞–ø—É—Å–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏</h2>
        <div style="margin-bottom: 15px;">
            <button id="syncPricesBtn" onclick="syncData('prices')" disabled>
                –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ü–µ–Ω—ã
            </button>
            <button id="syncStocksBtn" onclick="syncData('stocks')" disabled>
                –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ—Å—Ç–∞—Ç–∫–∏
            </button>
            <button id="syncOrdersBtn" onclick="syncData('orders')" disabled>
                –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–∫–∞–∑—ã
            </button>
        </div>
        <div style="margin-top: 10px;">
            <button id="syncAllBtn" onclick="syncAll()" disabled style="background: #7c3aed;">
                üöÄ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –í–°–Å
            </button>
        </div>
        <div id="sync-result"></div>
    </div>

    <div class="section">
        <h2>–®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏</h2>
        <button id="logsBtn" onclick="checkLogs()" disabled>–ó–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–≥–∏</button>
        <div id="logs-result"></div>
    </div>

    <script>
        let authToken = null;
        let accountId = 2;

        function getToken() {
            const persistToken = localStorage.getItem('_x_auth_token');
            if (persistToken) {
                try {
                    return JSON.parse(persistToken);
                } catch (e) {
                    return persistToken;
                }
            }
            return localStorage.getItem('auth_token') || localStorage.getItem('token');
        }

        function getAuthHeaders() {
            return {
                'Authorization': 'Bearer ' + authToken,
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            };
        }

        async function checkAuth() {
            const resultDiv = document.getElementById('auth-result');
            resultDiv.innerHTML = '<p>‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞...</p>';

            authToken = getToken();

            if (!authToken) {
                resultDiv.innerHTML = '<div class="error">‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω! <a href="/login">–í–æ–π—Ç–∏</a></div>';
                return;
            }

            try {
                const res = await fetch('/api/me', {
                    headers: getAuthHeaders()
                });

                const data = await res.json();

                if (res.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">‚úÖ –¢–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω</div>
                        <pre>User: ${data.name} (${data.email})
ID: ${data.id}
Current Company: ${data.current_company_id || '–Ω–µ –≤—ã–±—Ä–∞–Ω–∞'}</pre>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå –¢–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω (${res.status})</div>`;
                }
            } catch (e) {
                resultDiv.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${e.message}</div>`;
            }
        }

        async function checkAccount() {
            accountId = document.getElementById('accountId').value;
            const resultDiv = document.getElementById('account-result');
            resultDiv.innerHTML = '<p>‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞...</p>';

            if (!authToken) {
                resultDiv.innerHTML = '<div class="error">‚ùå –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é</div>';
                return;
            }

            try {
                const res = await fetch(`/api/marketplace/accounts/${accountId}`, {
                    headers: getAuthHeaders()
                });

                const data = await res.json();

                if (res.ok) {
                    const account = data.account;
                    resultDiv.innerHTML = `
                        <div class="success">‚úÖ –ê–∫–∫–∞—É–Ω—Ç –Ω–∞–π–¥–µ–Ω</div>
                        <pre>ID: ${account.id}
Marketplace: ${account.marketplace_type}
Label: ${account.marketplace_label}
Status: ${account.is_active ? 'Active' : 'Inactive'}
Has API Key: ${account.has_api_key ? 'Yes ‚úÖ' : 'No ‚ùå'}</pre>
                    `;

                    if (account.has_api_key) {
                        // –í–∫–ª—é—á–∏—Ç—å –∫–Ω–æ–ø–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                        document.getElementById('syncPricesBtn').disabled = false;
                        document.getElementById('syncStocksBtn').disabled = false;
                        document.getElementById('syncOrdersBtn').disabled = false;
                        document.getElementById('syncAllBtn').disabled = false;
                        document.getElementById('logsBtn').disabled = false;
                    } else {
                        resultDiv.innerHTML += `
                            <div class="error">‚ùå WB —Ç–æ–∫–µ–Ω –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!
                            <a href="/marketplace/${accountId}/wb-settings">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–∫–µ–Ω</a></div>
                        `;
                    }
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">‚ùå –û—à–∏–±–∫–∞ (${res.status})</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (e) {
                resultDiv.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${e.message}</div>`;
            }
        }

        async function syncData(type) {
            const resultDiv = document.getElementById('sync-result');
            const btnId = `sync${type.charAt(0).toUpperCase() + type.slice(1)}Btn`;
            const btn = document.getElementById(btnId);

            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...';
            resultDiv.innerHTML = `<div class="info">‚è≥ –ó–∞–ø—É—Å–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ ${type}...</div>`;

            try {
                const res = await fetch(`/api/marketplace/accounts/${accountId}/sync/${type}`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });

                const data = await res.json();

                console.log('Sync response:', data);

                if (res.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">‚úÖ ${data.message}</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                    setTimeout(() => checkLogs(), 2000);
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">‚ùå –û—à–∏–±–∫–∞ (${res.status}): ${data.message || 'Unknown error'}</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (e) {
                resultDiv.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${e.message}</div>`;
            }

            btn.disabled = false;
            btn.innerHTML = btn.innerHTML.replace('<span class="loading"></span>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...',
                `–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å ${type === 'prices' ? '—Ü–µ–Ω—ã' : type === 'stocks' ? '–æ—Å—Ç–∞—Ç–∫–∏' : '–∑–∞–∫–∞–∑—ã'}`);
        }

        async function syncAll() {
            const resultDiv = document.getElementById('sync-result');
            const btn = document.getElementById('syncAllBtn');

            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...';
            resultDiv.innerHTML = '<div class="info">‚è≥ –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏...</div>';

            try {
                const res = await fetch(`/api/marketplace/accounts/${accountId}/sync/all`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });

                const data = await res.json();

                console.log('Sync all response:', data);

                if (res.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">‚úÖ ${data.message}</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                        <div class="info">üí° –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —á–µ—Ä–µ–∑ 5-10 —Å–µ–∫—É–Ω–¥.</div>
                    `;
                    setTimeout(() => checkLogs(), 3000);
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">‚ùå –û—à–∏–±–∫–∞ (${res.status}): ${data.message || 'Unknown error'}</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (e) {
                resultDiv.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${e.message}</div>`;
            }

            btn.disabled = false;
            btn.innerHTML = 'üöÄ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –í–°–Å';
        }

        async function checkLogs() {
            const resultDiv = document.getElementById('logs-result');
            resultDiv.innerHTML = '<p>‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤...</p>';

            try {
                const res = await fetch(`/api/marketplace/accounts/${accountId}/logs`, {
                    headers: getAuthHeaders()
                });

                const data = await res.json();

                if (res.ok) {
                    const logs = data.logs || [];

                    if (logs.length === 0) {
                        resultDiv.innerHTML = '<div class="info">‚ÑπÔ∏è –õ–æ–≥–æ–≤ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
                        return;
                    }

                    let logsHtml = '<div class="success">‚úÖ –õ–æ–≥–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</div>';
                    logsHtml += '<div style="max-height: 400px; overflow-y: auto;">';

                    logs.forEach(log => {
                        const statusClass = log.status === 'success' ? 'success' :
                                          log.status === 'error' ? 'error' : 'info';
                        const statusEmoji = log.status === 'success' ? '‚úÖ' :
                                          log.status === 'error' ? '‚ùå' : '‚è≥';

                        logsHtml += `
                            <div class="${statusClass}" style="margin: 10px 0;">
                                <strong>${statusEmoji} ${log.sync_type}</strong>
                                <div style="font-size: 12px; margin-top: 5px;">
                                    Status: ${log.status}<br>
                                    Time: ${log.created_at}<br>
                                    ${log.message ? 'Message: ' + log.message : ''}
                                </div>
                            </div>
                        `;
                    });

                    logsHtml += '</div>';
                    resultDiv.innerHTML = logsHtml;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤ (${res.status})</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (e) {
                resultDiv.innerHTML = `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${e.message}</div>`;
            }
        }

        // Auto-check auth on load
        window.addEventListener('load', () => {
            const token = getToken();
            if (token) {
                authToken = token;
                checkAuth();
            }
        });
    </script>
</body>
</html>
