import{a as t}from"./vendor-Dos3PyFQ.js";import{m as e,a}from"./alpine-w3y3or6b.js";window.axios=t,window.axios.defaults.headers.common["X-Requested-With"]="XMLHttpRequest";let s=null,i=null,n=!1;const o=new Set,r=new Set;let c=0;window.subscribeToChannel=function(t){return r.add(t),!(!s||s.readyState!==WebSocket.OPEN)&&(o.has(t)||(s.send(JSON.stringify({event:"pusher:subscribe",data:{channel:t}})),o.add(t)),!0)},window.unsubscribeFromChannel=function(t){r.delete(t),s&&s.readyState===WebSocket.OPEN&&(s.send(JSON.stringify({event:"pusher:unsubscribe",data:{channel:t}})),o.delete(t))},window.getWebSocketState=function(){return{connected:n,socketId:i,connection:s,reconnectAttempts:c}},window.reconnectWebSocket=function(){s&&s.close(),c=0};window.pollingManager=new class{constructor(){this.intervals=new Map,this.callbacks=new Map,this.lastCheckTimes=new Map,this.isActive=!0,this.config=window.pollingConfig||{}}start(t,e,a,s=15e3){this.intervals.has(t)&&this.stop(t),this.callbacks.set(t,a),this.lastCheckTimes.set(t,(new Date).toISOString());const i=async()=>{if(this.isActive)try{const s=e.includes("?")?"&":"?",i=`${e}${s}last_check=${this.lastCheckTimes.get(t)}`,n=await fetch(i,{headers:{Authorization:`Bearer ${this.getToken()}`,Accept:"application/json","X-Requested-With":"XMLHttpRequest"},credentials:"include"});if(!n.ok){if(401===n.status)return void this.stop(t);throw new Error(`HTTP ${n.status}: ${n.statusText}`)}const o=await n.json();o.timestamp&&this.lastCheckTimes.set(t,o.timestamp),a&&"function"==typeof a&&a(o)}catch(s){}};i();const n=setInterval(i,s);this.intervals.set(t,n)}stop(t){this.intervals.has(t)&&(clearInterval(this.intervals.get(t)),this.intervals.delete(t),this.callbacks.delete(t),this.lastCheckTimes.delete(t))}stopAll(){this.intervals.forEach((t,e)=>{clearInterval(t)}),this.intervals.clear(),this.callbacks.clear(),this.lastCheckTimes.clear()}pause(){this.isActive=!1}resume(){this.isActive=!0,this.intervals.forEach((t,e)=>{this.callbacks.get(e)&&setTimeout(()=>{},100)})}getStats(){return{active_count:this.intervals.size,is_active:this.isActive,keys:Array.from(this.intervals.keys())}}isRunning(t){return this.intervals.has(t)}getToken(){const t=localStorage.getItem("auth_token");if(t)return t;const e=document.querySelector('meta[name="csrf-token"]');return e?e.content:window.authToken?window.authToken:""}},document.addEventListener("visibilitychange",()=>{document.hidden?window.pollingManager.pause():window.pollingManager.resume()}),window.addEventListener("beforeunload",()=>{window.pollingManager.stopAll()});const l=t.create({baseURL:"/api",headers:{"Content-Type":"application/json",Accept:"application/json"}});l.interceptors.request.use(t=>{let e=localStorage.getItem("_x_auth_token");if(e)try{e=JSON.parse(e)}catch(a){}return e||(e=localStorage.getItem("auth_token")),e&&(t.headers.Authorization=`Bearer ${e}`),t}),l.interceptors.response.use(t=>t,t=>(401===t.response?.status&&(localStorage.removeItem("_x_auth_token"),localStorage.removeItem("_x_auth_user"),localStorage.removeItem("_x_current_company"),localStorage.removeItem("auth_token"),localStorage.removeItem("user"),window.location.pathname.includes("/login")||(window.location.href="/login")),Promise.reject(t)));const d={register:async t=>(await l.post("/auth/register",t)).data,login:async(t,e)=>(await l.post("/auth/login",{email:t,password:e})).data,async logout(){try{await l.post("/auth/logout")}catch(t){}localStorage.removeItem("_x_auth_token"),localStorage.removeItem("_x_auth_user"),localStorage.removeItem("_x_current_company"),localStorage.removeItem("auth_token"),localStorage.removeItem("user")},me:async()=>(await l.get("/me")).data,getUser(){const t=localStorage.getItem("user");return t?JSON.parse(t):null},isAuthenticated:()=>!!localStorage.getItem("auth_token")},h={list:async()=>(await l.get("/companies")).data.companies,create:async t=>(await l.post("/companies",t)).data.company},u={list:async(t,e={})=>(await l.get("/products",{params:{company_id:t,...e}})).data,get:async t=>(await l.get(`/products/${t}`)).data.product,create:async t=>(await l.post("/products",t)).data.product,update:async(t,e)=>(await l.put(`/products/${t}`,e)).data.product,async delete(t){await l.delete(`/products/${t}`)}},g={list:async(t,e={})=>(await l.get("/dialogs",{params:{company_id:t,...e}})).data,get:async t=>(await l.get(`/dialogs/${t}`)).data.dialog,create:async(t,e=null,a="general",s=!1)=>(await l.post("/dialogs",{company_id:t,title:e,category:a,is_private:s})).data.dialog,hide:async t=>(await l.post(`/dialogs/${t}/hide`)).data},m={send:async t=>(await l.post("/chat",t)).data,generateCard:async t=>(await l.post("/chat/generate-card",t)).data.card,generateReviewResponse:async t=>(await l.post("/chat/generate-review-response",t)).data.responses},p={async upload(t,e,a=!1){const s=new FormData;s.append("image",e),s.append("is_primary",a);return(await l.post(`/products/${t}/images/upload`,s,{headers:{"Content-Type":"multipart/form-data"}})).data.image},generate:async(t,e,a="medium",s=1)=>(await l.post(`/products/${t}/images/generate`,{prompt:e,quality:a,count:s})).data.images},w={list:async(t,e={})=>(await l.get("/agent/tasks",{params:{company_id:t,...e}})).data,get:async t=>(await l.get(`/agent/tasks/${t}`)).data.task,create:async(t,e,a)=>(await l.post("/agent/tasks",{company_id:t,type:e,input_data:a})).data.task};function y(t,a){try{return e.$persist(t).as(a)}catch(s){return localStorage.removeItem("_x_"+a),localStorage.removeItem(a),t}}e.plugin(a);try{["auth_user","auth_token","current_company"].forEach(t=>{const e="_x_"+t,a=localStorage.getItem(e);if(a)try{JSON.parse(a)}catch(s){localStorage.removeItem(e),localStorage.removeItem(t)}})}catch(_){}window.api={...l,auth:d,companies:h,products:u,dialogs:g,chat:m,images:p,tasks:w,get:l.get,post:l.post,delete:l.delete},e.store("auth",{user:y(null,"auth_user"),token:y(null,"auth_token"),currentCompany:y(null,"current_company"),companies:[],showCompanyPrompt:!1,get isAuthenticated(){return!!this.token},get hasCompanies(){return this.companies.length>0},async login(t,e){const a=await d.login(t,e);return this.user=a.user,this.token=a.token,await this.loadCompanies(),a},async register(t){const e=await d.register(t);return this.user=e.user,this.token=e.token,await this.loadCompanies(),e},async loadCompanies(){try{if(this.companies=await h.list(),this.companies.length>0){if(!(this.currentCompany&&this.companies.some(t=>t.id===this.currentCompany.id))){const t=this.user?.company_id,e=t?this.companies.find(e=>e.id===t):null;this.currentCompany=e||this.companies[0]}this.showCompanyPrompt=!1}else this.showCompanyPrompt=!0,this.currentCompany=null;this.currentCompany&&await e.store("chat").loadDialogs(this.currentCompany.id)}catch(_){}},async logout(){await d.logout(),this.user=null,this.token=null,this.currentCompany=null,this.companies=[]},setCompany(t){this.currentCompany=t,t&&e.store("chat").loadDialogs(t.id)}}),e.store("chat",{dialogs:[],currentDialog:null,messages:[],loading:!1,async loadDialogs(t){try{const e=await g.list(t);this.dialogs=e.dialogs||[]}catch(_){this.dialogs=[]}},async loadDialog(t){this.loading=!0;const e=await g.get(t);this.currentDialog=e,this.messages=e.messages||[],this.loading=!1},async sendMessage(t,a={}){this.loading=!0;const s={message:t,mode:a.mode||"chat",model:a.model||"fast"};if(a.image_model&&(s.image_model=a.image_model),a.is_private&&(s.is_private=!0),this.currentDialog)s.dialog_id=this.currentDialog.id;else{const t=e.store("auth");s.company_id=t.currentCompany?.id}a.images?.length&&(s.images=a.images);const i={id:"temp-"+Date.now(),sender:"user",content:t,created_at:(new Date).toISOString()};this.messages.push(i);try{const t=await m.send(s);if(this.currentDialog){const e=this.dialogs.findIndex(e=>e.id===t.dialog.id);-1!==e&&(this.dialogs[e]=t.dialog)}else this.currentDialog=t.dialog,this.dialogs.unshift(t.dialog);const e=this.messages.findIndex(t=>t.id===i.id);return-1!==e&&(this.messages[e]=t.user_message),this.messages.push(t.assistant_message),this.loading=!1,t}catch(n){throw this.messages=this.messages.filter(t=>t.id!==i.id),this.loading=!1,n}},newChat(){this.currentDialog=null,this.messages=[]}}),e.store("products",{items:[],current:null,loading:!1,meta:{},async load(t,e={}){this.loading=!0;const a=await u.list(t,e);this.items=a.products,this.meta=a.meta,this.loading=!1},async get(t){return this.loading=!0,this.current=await u.get(t),this.loading=!1,this.current},async create(t){const e=await u.create(t);return this.items.unshift(e),e}}),window.Alpine=e,e.start();
