import{a as t}from"./vendor-Dos3PyFQ.js";import{m as e,a as n}from"./alpine-w3y3or6b.js";window.axios=t,window.axios.defaults.headers.common["X-Requested-With"]="XMLHttpRequest";let i=null,a=null,s=!1;const o=new Set,r=new Set;let c=0;window.subscribeToChannel=function(t){return r.add(t),!(!i||i.readyState!==WebSocket.OPEN)&&(o.has(t)||(i.send(JSON.stringify({event:"pusher:subscribe",data:{channel:t}})),o.add(t)),!0)},window.unsubscribeFromChannel=function(t){r.delete(t),i&&i.readyState===WebSocket.OPEN&&(i.send(JSON.stringify({event:"pusher:unsubscribe",data:{channel:t}})),o.delete(t))},window.getWebSocketState=function(){return{connected:s,socketId:a,connection:i,reconnectAttempts:c}},window.reconnectWebSocket=function(){i&&i.close(),c=0};window.pollingManager=new class{constructor(){this.intervals=new Map,this.callbacks=new Map,this.lastCheckTimes=new Map,this.isActive=!0,this.config=window.pollingConfig||{}}start(t,e,n,i=15e3){this.intervals.has(t)&&this.stop(t),this.callbacks.set(t,n),this.lastCheckTimes.set(t,(new Date).toISOString());const a=async()=>{if(this.isActive)try{const i=e.includes("?")?"&":"?",a=`${e}${i}last_check=${this.lastCheckTimes.get(t)}`,s=await fetch(a,{headers:{Authorization:`Bearer ${this.getToken()}`,Accept:"application/json","X-Requested-With":"XMLHttpRequest"},credentials:"include"});if(!s.ok){if(401===s.status)return void this.stop(t);throw new Error(`HTTP ${s.status}: ${s.statusText}`)}const o=await s.json();o.timestamp&&this.lastCheckTimes.set(t,o.timestamp),n&&"function"==typeof n&&n(o)}catch(i){}};a();const s=setInterval(a,i);this.intervals.set(t,s)}stop(t){this.intervals.has(t)&&(clearInterval(this.intervals.get(t)),this.intervals.delete(t),this.callbacks.delete(t),this.lastCheckTimes.delete(t))}stopAll(){this.intervals.forEach((t,e)=>{clearInterval(t)}),this.intervals.clear(),this.callbacks.clear(),this.lastCheckTimes.clear()}pause(){this.isActive=!1}resume(){this.isActive=!0,this.intervals.forEach((t,e)=>{this.callbacks.get(e)&&setTimeout(()=>{},100)})}getStats(){return{active_count:this.intervals.size,is_active:this.isActive,keys:Array.from(this.intervals.keys())}}isRunning(t){return this.intervals.has(t)}getToken(){const t=localStorage.getItem("auth_token");if(t)return t;const e=document.querySelector('meta[name="csrf-token"]');return e?e.content:window.authToken?window.authToken:""}},document.addEventListener("visibilitychange",()=>{document.hidden?window.pollingManager.pause():window.pollingManager.resume()}),window.addEventListener("beforeunload",()=>{window.pollingManager.stopAll()});const l=new class{constructor(){this.isSupported="vibrate"in navigator,this.isEnabled=!0;const t=localStorage.getItem("haptic_enabled");null!==t&&(this.isEnabled="true"===t)}enable(){this.isEnabled=!0,localStorage.setItem("haptic_enabled","true")}disable(){this.isEnabled=!1,localStorage.setItem("haptic_enabled","false")}toggle(){return this.isEnabled?this.disable():this.enable(),this.isEnabled}canVibrate(){return this.isSupported&&this.isEnabled}light(){this.canVibrate()&&navigator.vibrate(10)}medium(){this.canVibrate()&&navigator.vibrate(20)}heavy(){this.canVibrate()&&navigator.vibrate(40)}success(){this.canVibrate()&&navigator.vibrate([10,50,10])}error(){this.canVibrate()&&navigator.vibrate([30,50,30,50,30])}notification(){this.canVibrate()&&navigator.vibrate([15,30,15])}selection(){this.canVibrate()&&navigator.vibrate(5)}impact(){this.canVibrate()&&navigator.vibrate(25)}custom(t){this.canVibrate()&&navigator.vibrate(t)}};window.haptic=l,window.Alpine&&document.addEventListener("alpine:init",()=>{Alpine.magic("haptic",()=>l)}),document.addEventListener("DOMContentLoaded",()=>{document.addEventListener("click",t=>{const e=t.target.closest("[data-haptic]");if(!e)return;switch(e.dataset.haptic||"light"){case"light":default:l.light();break;case"medium":l.medium();break;case"heavy":l.heavy();break;case"success":l.success();break;case"error":l.error();break;case"selection":l.selection();break;case"impact":l.impact()}}),l.isSupported});class h{constructor(t,e={}){this.element=t,this.options={threshold:80,maxDistance:120,resistance:2.5,onRefresh:e.onRefresh||(()=>Promise.resolve()),enabled:!0,...e},this.touchStartY=0,this.touchCurrentY=0,this.pulling=!1,this.refreshing=!1,this.distance=0,this.createIndicator(),this.attachListeners()}createIndicator(){this.indicator=document.createElement("div"),this.indicator.className="pull-to-refresh-indicator",this.indicator.innerHTML='\n            <div class="pull-to-refresh-content">\n                <div class="pull-to-refresh-spinner">\n                    <svg class="animate-spin h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24">\n                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>\n                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>\n                    </svg>\n                </div>\n                <div class="pull-to-refresh-arrow">\n                    <svg class="h-5 w-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 14l-7 7m0 0l-7-7m7 7V3"/>\n                    </svg>\n                </div>\n                <div class="pull-to-refresh-text text-sm font-medium text-gray-600"></div>\n            </div>\n        ',this.element.parentNode.insertBefore(this.indicator,this.element),this.spinner=this.indicator.querySelector(".pull-to-refresh-spinner"),this.arrow=this.indicator.querySelector(".pull-to-refresh-arrow"),this.text=this.indicator.querySelector(".pull-to-refresh-text")}attachListeners(){this.element.addEventListener("touchstart",this.onTouchStart.bind(this),{passive:!0}),this.element.addEventListener("touchmove",this.onTouchMove.bind(this),{passive:!1}),this.element.addEventListener("touchend",this.onTouchEnd.bind(this),{passive:!0})}onTouchStart(t){this.options.enabled&&!this.refreshing&&(this.element.scrollTop>0||(this.touchStartY=t.touches[0].clientY,this.pulling=!1))}onTouchMove(t){if(!this.options.enabled||this.refreshing)return;if(this.element.scrollTop>0)return;this.touchCurrentY=t.touches[0].clientY;const e=this.touchCurrentY-this.touchStartY;e<0||(this.distance=Math.min(e/this.options.resistance,this.options.maxDistance),this.distance>5&&(this.pulling=!0,t.preventDefault(),this.updateIndicator()))}async onTouchEnd(){this.pulling&&!this.refreshing&&this.distance>=this.options.threshold?await this.refresh():this.reset()}updateIndicator(){const t=Math.min(this.distance/this.options.threshold,1),e=180*t;this.indicator.style.height=`${this.distance}px`,this.indicator.style.opacity=t,this.arrow.style.transform=`rotate(${e}deg)`,this.distance>=this.options.threshold?(this.text.textContent="Отпустите для обновления",this.arrow.style.transform="rotate(180deg) scale(1.1)"):this.text.textContent="Потяните для обновления"}async refresh(){this.refreshing=!0,this.pulling=!1,this.indicator.style.height=`${this.options.threshold}px`,this.arrow.style.display="none",this.spinner.style.display="block",this.text.textContent="Обновление...",window.haptic&&window.haptic.medium();try{await this.options.onRefresh(),window.haptic&&window.haptic.success()}catch(t){window.haptic&&window.haptic.error()}finally{setTimeout(()=>{this.reset(),this.refreshing=!1},500)}}reset(){this.pulling=!1,this.distance=0,this.indicator.style.transition="height 0.3s ease, opacity 0.3s ease",this.indicator.style.height="0px",this.indicator.style.opacity="0",this.arrow.style.transform="rotate(0deg)",this.arrow.style.display="block",this.spinner.style.display="none",setTimeout(()=>{this.indicator.style.transition=""},300)}enable(){this.options.enabled=!0}disable(){this.options.enabled=!1}destroy(){this.indicator.remove(),this.element.removeEventListener("touchstart",this.onTouchStart),this.element.removeEventListener("touchmove",this.onTouchMove),this.element.removeEventListener("touchend",this.onTouchEnd)}}window.Alpine&&document.addEventListener("alpine:init",()=>{Alpine.directive("pull-to-refresh",(t,{expression:e},{evaluate:n,cleanup:i})=>{const a=n(e),s=new h(t,{onRefresh:async()=>{"function"==typeof a&&await a()}});i(()=>{s.destroy()})})}),window.PullToRefresh=h;const d=document.createElement("style");d.textContent="\n    .pull-to-refresh-indicator {\n        position: absolute;\n        top: 0;\n        left: 0;\n        right: 0;\n        height: 0;\n        overflow: hidden;\n        display: flex;\n        align-items: flex-end;\n        justify-content: center;\n        background: linear-gradient(to bottom, rgba(249, 250, 251, 0) 0%, rgba(249, 250, 251, 1) 100%);\n        z-index: 10;\n        opacity: 0;\n        transition: none;\n    }\n\n    .pull-to-refresh-content {\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        padding-bottom: 1rem;\n    }\n\n    .pull-to-refresh-spinner,\n    .pull-to-refresh-arrow {\n        margin-bottom: 0.5rem;\n    }\n\n    .pull-to-refresh-spinner {\n        display: none;\n    }\n\n    .pull-to-refresh-arrow {\n        transition: transform 0.2s ease;\n    }\n\n    .pull-to-refresh-text {\n        white-space: nowrap;\n    }\n\n    /* Make sure parent is relative */\n    [x-data][x-pull-to-refresh],\n    .pull-to-refresh-container {\n        position: relative;\n    }\n",document.head.appendChild(d);new class{constructor(){this.isNavigating=!1,this.animationDuration=300,this.previousUrl=window.location.href,this.init()}init(){(window.isPWAInstalled||window.matchMedia("(display-mode: standalone)").matches||!0===window.navigator.standalone)&&this.setupNavigationDetection()}setupNavigationDetection(){document.addEventListener("click",t=>{const e=t.target.closest("a");if(!e)return;if("_blank"===e.target)return;if(e.download)return;if("external"===e.rel)return;const n=e.href;n&&n.startsWith(window.location.origin)&&n!==window.location.href&&(t.preventDefault(),this.navigateWithTransition(n,"forward"))}),window.addEventListener("popstate",t=>{const e=window.location.href,n=this.getNavigationDirection(e);this.applyTransition(n)})}getNavigationDirection(t){return t.length<this.previousUrl.length?"back":"forward"}async navigateWithTransition(t,e="forward"){this.isNavigating||(this.isNavigating=!0,await this.applyTransition(e,"exit"),window.haptic&&window.haptic.light(),this.previousUrl=window.location.href,window.location.href=t)}async applyTransition(t,e="enter"){const n=document.body;n.classList.remove("page-transition-enter","page-transition-exit","page-transition-forward","page-transition-back"),n.offsetWidth,n.classList.add(`page-transition-${e}`),n.classList.add(`page-transition-${t}`),await new Promise(t=>setTimeout(t,this.animationDuration)),"exit"===e&&(this.isNavigating=!1)}};const p=document.createElement("style");p.textContent="\n    /* Disable default page transitions if user prefers reduced motion */\n    @media (prefers-reduced-motion: reduce) {\n        .page-transition-enter,\n        .page-transition-exit {\n            animation: none !important;\n            transition: none !important;\n        }\n    }\n\n    /* Page transition base */\n    body {\n        transition: none;\n    }\n\n    /* Forward navigation (slide from right) */\n    .page-transition-exit.page-transition-forward {\n        animation: slideOutLeft 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n    }\n\n    .page-transition-enter.page-transition-forward {\n        animation: slideInRight 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n    }\n\n    /* Back navigation (slide to right) */\n    .page-transition-exit.page-transition-back {\n        animation: slideOutRight 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n    }\n\n    .page-transition-enter.page-transition-back {\n        animation: slideInLeft 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n    }\n\n    /* Keyframes */\n    @keyframes slideInRight {\n        from {\n            opacity: 0;\n            transform: translateX(100%);\n        }\n        to {\n            opacity: 1;\n            transform: translateX(0);\n        }\n    }\n\n    @keyframes slideOutLeft {\n        from {\n            opacity: 1;\n            transform: translateX(0);\n        }\n        to {\n            opacity: 0;\n            transform: translateX(-30%);\n        }\n    }\n\n    @keyframes slideInLeft {\n        from {\n            opacity: 0;\n            transform: translateX(-30%);\n        }\n        to {\n            opacity: 1;\n            transform: translateX(0);\n        }\n    }\n\n    @keyframes slideOutRight {\n        from {\n            opacity: 1;\n            transform: translateX(0);\n        }\n        to {\n            opacity: 0;\n            transform: translateX(100%);\n        }\n    }\n\n    /* Fade transition (alternative) */\n    .page-transition-fade {\n        animation: fadeTransition 0.3s ease-in-out;\n    }\n\n    @keyframes fadeTransition {\n        0% { opacity: 1; }\n        50% { opacity: 0; }\n        100% { opacity: 1; }\n    }\n\n    /* Ensure smooth rendering */\n    body.page-transition-enter,\n    body.page-transition-exit {\n        overflow-x: hidden;\n    }\n",document.head.appendChild(p);const u=t.create({baseURL:"/api",headers:{"Content-Type":"application/json",Accept:"application/json"}});u.interceptors.request.use(t=>{let e=localStorage.getItem("_x_auth_token");if(e)try{e=JSON.parse(e)}catch(n){}return e||(e=localStorage.getItem("auth_token")),e&&(t.headers.Authorization=`Bearer ${e}`),t}),u.interceptors.response.use(t=>t,t=>(401===t.response?.status&&(localStorage.removeItem("_x_auth_token"),localStorage.removeItem("_x_auth_user"),localStorage.removeItem("_x_current_company"),localStorage.removeItem("auth_token"),localStorage.removeItem("user"),window.location.pathname.includes("/login")||(window.location.href="/login")),Promise.reject(t)));const m={register:async t=>(await u.post("/auth/register",t)).data,login:async(t,e)=>(await u.post("/auth/login",{email:t,password:e})).data,async logout(){try{await u.post("/auth/logout")}catch(t){}localStorage.removeItem("_x_auth_token"),localStorage.removeItem("_x_auth_user"),localStorage.removeItem("_x_current_company"),localStorage.removeItem("auth_token"),localStorage.removeItem("user")},me:async()=>(await u.get("/me")).data,getUser(){const t=localStorage.getItem("user");return t?JSON.parse(t):null},isAuthenticated:()=>!!localStorage.getItem("auth_token")},g={list:async()=>(await u.get("/companies")).data.companies,create:async t=>(await u.post("/companies",t)).data.company},w={list:async(t,e={})=>(await u.get("/products",{params:{company_id:t,...e}})).data,get:async t=>(await u.get(`/products/${t}`)).data.product,create:async t=>(await u.post("/products",t)).data.product,update:async(t,e)=>(await u.put(`/products/${t}`,e)).data.product,async delete(t){await u.delete(`/products/${t}`)}},y={list:async(t,e={})=>(await u.get("/dialogs",{params:{company_id:t,...e}})).data,get:async t=>(await u.get(`/dialogs/${t}`)).data.dialog,create:async(t,e=null,n="general",i=!1)=>(await u.post("/dialogs",{company_id:t,title:e,category:n,is_private:i})).data.dialog,hide:async t=>(await u.post(`/dialogs/${t}/hide`)).data},f={send:async t=>(await u.post("/chat",t)).data,generateCard:async t=>(await u.post("/chat/generate-card",t)).data.card,generateReviewResponse:async t=>(await u.post("/chat/generate-review-response",t)).data.responses},v={async upload(t,e,n=!1){const i=new FormData;i.append("image",e),i.append("is_primary",n);return(await u.post(`/products/${t}/images/upload`,i,{headers:{"Content-Type":"multipart/form-data"}})).data.image},generate:async(t,e,n="medium",i=1)=>(await u.post(`/products/${t}/images/generate`,{prompt:e,quality:n,count:i})).data.images},b={list:async(t,e={})=>(await u.get("/agent/tasks",{params:{company_id:t,...e}})).data,get:async t=>(await u.get(`/agent/tasks/${t}`)).data.task,create:async(t,e,n)=>(await u.post("/agent/tasks",{company_id:t,type:e,input_data:n})).data.task};function k(t,n){try{return e.$persist(t).as(n)}catch(i){return localStorage.removeItem("_x_"+n),localStorage.removeItem(n),t}}e.plugin(n);try{["auth_user","auth_token","current_company"].forEach(t=>{const e="_x_"+t,n=localStorage.getItem(e);if(n)try{JSON.parse(n)}catch(i){localStorage.removeItem(e),localStorage.removeItem(t)}})}catch(_){}window.api={...u,auth:m,companies:g,products:w,dialogs:y,chat:f,images:v,tasks:b,get:u.get,post:u.post,delete:u.delete},e.store("auth",{user:k(null,"auth_user"),token:k(null,"auth_token"),currentCompany:k(null,"current_company"),companies:[],showCompanyPrompt:!1,get isAuthenticated(){return!!this.token},get hasCompanies(){return this.companies.length>0},async login(t,e){const n=await m.login(t,e);return this.user=n.user,this.token=n.token,await this.loadCompanies(),n},async register(t){const e=await m.register(t);return this.user=e.user,this.token=e.token,await this.loadCompanies(),e},async loadCompanies(){try{if(this.companies=await g.list(),this.companies.length>0){if(!(this.currentCompany&&this.companies.some(t=>t.id===this.currentCompany.id))){const t=this.user?.company_id,e=t?this.companies.find(e=>e.id===t):null;this.currentCompany=e||this.companies[0]}this.showCompanyPrompt=!1}else this.showCompanyPrompt=!0,this.currentCompany=null;this.currentCompany&&await e.store("chat").loadDialogs(this.currentCompany.id)}catch(_){}},async logout(){await m.logout(),this.user=null,this.token=null,this.currentCompany=null,this.companies=[]},setCompany(t){this.currentCompany=t,t&&e.store("chat").loadDialogs(t.id)}}),e.store("chat",{dialogs:[],currentDialog:null,messages:[],loading:!1,async loadDialogs(t){try{const e=await y.list(t);this.dialogs=e.dialogs||[]}catch(_){this.dialogs=[]}},async loadDialog(t){this.loading=!0;const e=await y.get(t);this.currentDialog=e,this.messages=e.messages||[],this.loading=!1},async sendMessage(t,n={}){this.loading=!0;const i={message:t,mode:n.mode||"chat",model:n.model||"fast"};if(n.image_model&&(i.image_model=n.image_model),n.is_private&&(i.is_private=!0),this.currentDialog)i.dialog_id=this.currentDialog.id;else{const t=e.store("auth");i.company_id=t.currentCompany?.id}n.images?.length&&(i.images=n.images);const a={id:"temp-"+Date.now(),sender:"user",content:t,created_at:(new Date).toISOString()};this.messages.push(a);try{const t=await f.send(i);if(this.currentDialog){const e=this.dialogs.findIndex(e=>e.id===t.dialog.id);-1!==e&&(this.dialogs[e]=t.dialog)}else this.currentDialog=t.dialog,this.dialogs.unshift(t.dialog);const e=this.messages.findIndex(t=>t.id===a.id);return-1!==e&&(this.messages[e]=t.user_message),this.messages.push(t.assistant_message),this.loading=!1,t}catch(s){throw this.messages=this.messages.filter(t=>t.id!==a.id),this.loading=!1,s}},newChat(){this.currentDialog=null,this.messages=[]}}),e.store("products",{items:[],current:null,loading:!1,meta:{},async load(t,e={}){this.loading=!0;const n=await w.list(t,e);this.items=n.products,this.meta=n.meta,this.loading=!1},async get(t){return this.loading=!0,this.current=await w.get(t),this.loading=!1,this.current},async create(t){const e=await w.create(t);return this.items.unshift(e),e}}),window.Alpine=e,e.start();
