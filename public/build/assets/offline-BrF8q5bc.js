window.SmOffline=new class{constructor(){this.isOnline=navigator.onLine,this.listeners=[],window.addEventListener("online",()=>this.setOnline(!0)),window.addEventListener("offline",()=>this.setOnline(!1))}setOnline(t){this.isOnline=t,this.listeners.forEach(e=>e(t)),t?this.showToast("Соединение восстановлено","success"):this.showToast("Нет соединения","warning")}onStatusChange(t){this.listeners.push(t)}showToast(t,e="info"){const s=document.createElement("div");s.className="sm-toast sm-toast-"+e,s.textContent=t,document.body.appendChild(s),setTimeout(()=>s.classList.add("visible"),10),setTimeout(()=>{s.classList.remove("visible"),setTimeout(()=>s.remove(),300)},3e3)}async fetch(t,e={}){const s=e.cacheKey||t,n=e.storeName||"dashboard";let i=null;try{i=await window.SmCache.get(n,s)}catch(a){}if(!this.isOnline){if(i)return{data:i,fromCache:!0};throw new Error("Нет соединения и нет кэша")}try{const i=document.querySelector('meta[name="csrf-token"]')?.content,o=await fetch(t,{...e,headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest",...i?{"X-CSRF-TOKEN":i}:{},...e.headers}});if(!o.ok)throw new Error("HTTP "+o.status);const r=await o.json();try{await window.SmCache.set(n,s,r)}catch(a){}return{data:r,fromCache:!1}}catch(o){if(i)return{data:i,fromCache:!0};throw o}}};
