import{a as t}from"./vendor-Dos3PyFQ.js";import{m as e,a as s}from"./alpine-w3y3or6b.js";window.axios=t,window.axios.defaults.headers.common["X-Requested-With"]="XMLHttpRequest";let a=null,i=null,n=!1;const o=new Set,r=new Set;let c=0;window.subscribeToChannel=function(t){return r.add(t),!(!a||a.readyState!==WebSocket.OPEN)&&(o.has(t)||(a.send(JSON.stringify({event:"pusher:subscribe",data:{channel:t}})),o.add(t)),!0)},window.unsubscribeFromChannel=function(t){r.delete(t),a&&a.readyState===WebSocket.OPEN&&(a.send(JSON.stringify({event:"pusher:unsubscribe",data:{channel:t}})),o.delete(t))},window.getWebSocketState=function(){return{connected:n,socketId:i,connection:a,reconnectAttempts:c}},window.reconnectWebSocket=function(){a&&a.close(),c=0};window.pollingManager=new class{constructor(){this.intervals=new Map,this.callbacks=new Map,this.lastCheckTimes=new Map,this.isActive=!0,this.config=window.pollingConfig||{}}start(t,e,s,a=15e3){this.intervals.has(t)&&this.stop(t),this.callbacks.set(t,s),this.lastCheckTimes.set(t,(new Date).toISOString());const i=async()=>{if(this.isActive)try{const a=e.includes("?")?"&":"?",i=`${e}${a}last_check=${this.lastCheckTimes.get(t)}`,n=await fetch(i,{headers:{Authorization:`Bearer ${this.getToken()}`,Accept:"application/json","X-Requested-With":"XMLHttpRequest"},credentials:"include"});if(!n.ok){if(401===n.status)return void this.stop(t);throw new Error(`HTTP ${n.status}: ${n.statusText}`)}const o=await n.json();o.timestamp&&this.lastCheckTimes.set(t,o.timestamp),s&&"function"==typeof s&&s(o)}catch(a){}};i();const n=setInterval(i,a);this.intervals.set(t,n)}stop(t){this.intervals.has(t)&&(clearInterval(this.intervals.get(t)),this.intervals.delete(t),this.callbacks.delete(t),this.lastCheckTimes.delete(t))}stopAll(){this.intervals.forEach((t,e)=>{clearInterval(t)}),this.intervals.clear(),this.callbacks.clear(),this.lastCheckTimes.clear()}pause(){this.isActive=!1}resume(){this.isActive=!0,this.intervals.forEach((t,e)=>{this.callbacks.get(e)&&setTimeout(()=>{},100)})}getStats(){return{active_count:this.intervals.size,is_active:this.isActive,keys:Array.from(this.intervals.keys())}}isRunning(t){return this.intervals.has(t)}getToken(){const t=localStorage.getItem("auth_token");if(t)return t;const e=document.querySelector('meta[name="csrf-token"]');return e?e.content:window.authToken?window.authToken:""}},document.addEventListener("visibilitychange",()=>{document.hidden?window.pollingManager.pause():window.pollingManager.resume()}),window.addEventListener("beforeunload",()=>{window.pollingManager.stopAll()});const l=new class{constructor(){this.isSupported="vibrate"in navigator,this.isEnabled=!0;const t=localStorage.getItem("haptic_enabled");null!==t&&(this.isEnabled="true"===t)}enable(){this.isEnabled=!0,localStorage.setItem("haptic_enabled","true")}disable(){this.isEnabled=!1,localStorage.setItem("haptic_enabled","false")}toggle(){return this.isEnabled?this.disable():this.enable(),this.isEnabled}canVibrate(){return this.isSupported&&this.isEnabled}light(){this.canVibrate()&&navigator.vibrate(10)}medium(){this.canVibrate()&&navigator.vibrate(20)}heavy(){this.canVibrate()&&navigator.vibrate(40)}success(){this.canVibrate()&&navigator.vibrate([10,50,10])}error(){this.canVibrate()&&navigator.vibrate([30,50,30,50,30])}notification(){this.canVibrate()&&navigator.vibrate([15,30,15])}selection(){this.canVibrate()&&navigator.vibrate(5)}impact(){this.canVibrate()&&navigator.vibrate(25)}custom(t){this.canVibrate()&&navigator.vibrate(t)}};window.haptic=l,window.Alpine&&document.addEventListener("alpine:init",()=>{Alpine.magic("haptic",()=>l)}),document.addEventListener("DOMContentLoaded",()=>{document.addEventListener("click",t=>{const e=t.target.closest("[data-haptic]");if(!e)return;switch(e.dataset.haptic||"light"){case"light":default:l.light();break;case"medium":l.medium();break;case"heavy":l.heavy();break;case"success":l.success();break;case"error":l.error();break;case"selection":l.selection();break;case"impact":l.impact()}}),l.isSupported});class h{constructor(t,e={}){this.element=t,this.options={threshold:80,maxDistance:120,resistance:2.5,onRefresh:e.onRefresh||(()=>Promise.resolve()),enabled:!0,...e},this.touchStartY=0,this.touchCurrentY=0,this.pulling=!1,this.refreshing=!1,this.distance=0,this.createIndicator(),this.attachListeners()}createIndicator(){this.indicator=document.createElement("div"),this.indicator.className="pull-to-refresh-indicator",this.indicator.innerHTML='\n            <div class="pull-to-refresh-content">\n                <div class="pull-to-refresh-spinner">\n                    <svg class="animate-spin h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24">\n                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>\n                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>\n                    </svg>\n                </div>\n                <div class="pull-to-refresh-arrow">\n                    <svg class="h-5 w-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 14l-7 7m0 0l-7-7m7 7V3"/>\n                    </svg>\n                </div>\n                <div class="pull-to-refresh-text text-sm font-medium text-gray-600"></div>\n            </div>\n        ',this.element.parentNode.insertBefore(this.indicator,this.element),this.spinner=this.indicator.querySelector(".pull-to-refresh-spinner"),this.arrow=this.indicator.querySelector(".pull-to-refresh-arrow"),this.text=this.indicator.querySelector(".pull-to-refresh-text")}attachListeners(){this.element.addEventListener("touchstart",this.onTouchStart.bind(this),{passive:!0}),this.element.addEventListener("touchmove",this.onTouchMove.bind(this),{passive:!1}),this.element.addEventListener("touchend",this.onTouchEnd.bind(this),{passive:!0})}onTouchStart(t){this.options.enabled&&!this.refreshing&&(this.element.scrollTop>0||(this.touchStartY=t.touches[0].clientY,this.pulling=!1))}onTouchMove(t){if(!this.options.enabled||this.refreshing)return;if(this.element.scrollTop>0)return;this.touchCurrentY=t.touches[0].clientY;const e=this.touchCurrentY-this.touchStartY;e<0||(this.distance=Math.min(e/this.options.resistance,this.options.maxDistance),this.distance>5&&(this.pulling=!0,t.preventDefault(),this.updateIndicator()))}async onTouchEnd(){this.pulling&&!this.refreshing&&this.distance>=this.options.threshold?await this.refresh():this.reset()}updateIndicator(){const t=Math.min(this.distance/this.options.threshold,1),e=180*t;this.indicator.style.height=`${this.distance}px`,this.indicator.style.opacity=t,this.arrow.style.transform=`rotate(${e}deg)`,this.distance>=this.options.threshold?(this.text.textContent="Отпустите для обновления",this.arrow.style.transform="rotate(180deg) scale(1.1)"):this.text.textContent="Потяните для обновления"}async refresh(){this.refreshing=!0,this.pulling=!1,this.indicator.style.height=`${this.options.threshold}px`,this.arrow.style.display="none",this.spinner.style.display="block",this.text.textContent="Обновление...",window.haptic&&window.haptic.medium();try{await this.options.onRefresh(),window.haptic&&window.haptic.success()}catch(t){window.haptic&&window.haptic.error()}finally{setTimeout(()=>{this.reset(),this.refreshing=!1},500)}}reset(){this.pulling=!1,this.distance=0,this.indicator.style.transition="height 0.3s ease, opacity 0.3s ease",this.indicator.style.height="0px",this.indicator.style.opacity="0",this.arrow.style.transform="rotate(0deg)",this.arrow.style.display="block",this.spinner.style.display="none",setTimeout(()=>{this.indicator.style.transition=""},300)}enable(){this.options.enabled=!0}disable(){this.options.enabled=!1}destroy(){this.indicator.remove(),this.element.removeEventListener("touchstart",this.onTouchStart),this.element.removeEventListener("touchmove",this.onTouchMove),this.element.removeEventListener("touchend",this.onTouchEnd)}}window.Alpine&&document.addEventListener("alpine:init",()=>{Alpine.directive("pull-to-refresh",(t,{expression:e},{evaluate:s,cleanup:a})=>{const i=s(e),n=new h(t,{onRefresh:async()=>{"function"==typeof i&&await i()}});a(()=>{n.destroy()})})}),window.PullToRefresh=h;const d=document.createElement("style");d.textContent="\n    .pull-to-refresh-indicator {\n        position: absolute;\n        top: 0;\n        left: 0;\n        right: 0;\n        height: 0;\n        overflow: hidden;\n        display: flex;\n        align-items: flex-end;\n        justify-content: center;\n        background: linear-gradient(to bottom, rgba(249, 250, 251, 0) 0%, rgba(249, 250, 251, 1) 100%);\n        z-index: 10;\n        opacity: 0;\n        transition: none;\n    }\n\n    .pull-to-refresh-content {\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        padding-bottom: 1rem;\n    }\n\n    .pull-to-refresh-spinner,\n    .pull-to-refresh-arrow {\n        margin-bottom: 0.5rem;\n    }\n\n    .pull-to-refresh-spinner {\n        display: none;\n    }\n\n    .pull-to-refresh-arrow {\n        transition: transform 0.2s ease;\n    }\n\n    .pull-to-refresh-text {\n        white-space: nowrap;\n    }\n\n    /* Make sure parent is relative */\n    [x-data][x-pull-to-refresh],\n    .pull-to-refresh-container {\n        position: relative;\n    }\n",document.head.appendChild(d);const u=t.create({baseURL:"/api",headers:{"Content-Type":"application/json",Accept:"application/json"}});u.interceptors.request.use(t=>{let e=localStorage.getItem("_x_auth_token");if(e)try{e=JSON.parse(e)}catch(s){}return e||(e=localStorage.getItem("auth_token")),e&&(t.headers.Authorization=`Bearer ${e}`),t}),u.interceptors.response.use(t=>t,t=>(401===t.response?.status&&(localStorage.removeItem("_x_auth_token"),localStorage.removeItem("_x_auth_user"),localStorage.removeItem("_x_current_company"),localStorage.removeItem("auth_token"),localStorage.removeItem("user"),window.location.pathname.includes("/login")||(window.location.href="/login")),Promise.reject(t)));const p={register:async t=>(await u.post("/auth/register",t)).data,login:async(t,e)=>(await u.post("/auth/login",{email:t,password:e})).data,async logout(){try{await u.post("/auth/logout")}catch(t){}localStorage.removeItem("_x_auth_token"),localStorage.removeItem("_x_auth_user"),localStorage.removeItem("_x_current_company"),localStorage.removeItem("auth_token"),localStorage.removeItem("user")},me:async()=>(await u.get("/me")).data,getUser(){const t=localStorage.getItem("user");return t?JSON.parse(t):null},isAuthenticated:()=>!!localStorage.getItem("auth_token")},m={list:async()=>(await u.get("/companies")).data.companies,create:async t=>(await u.post("/companies",t)).data.company},g={list:async(t,e={})=>(await u.get("/products",{params:{company_id:t,...e}})).data,get:async t=>(await u.get(`/products/${t}`)).data.product,create:async t=>(await u.post("/products",t)).data.product,update:async(t,e)=>(await u.put(`/products/${t}`,e)).data.product,async delete(t){await u.delete(`/products/${t}`)}},w={list:async(t,e={})=>(await u.get("/dialogs",{params:{company_id:t,...e}})).data,get:async t=>(await u.get(`/dialogs/${t}`)).data.dialog,create:async(t,e=null,s="general",a=!1)=>(await u.post("/dialogs",{company_id:t,title:e,category:s,is_private:a})).data.dialog,hide:async t=>(await u.post(`/dialogs/${t}/hide`)).data},y={send:async t=>(await u.post("/chat",t)).data,generateCard:async t=>(await u.post("/chat/generate-card",t)).data.card,generateReviewResponse:async t=>(await u.post("/chat/generate-review-response",t)).data.responses},v={async upload(t,e,s=!1){const a=new FormData;a.append("image",e),a.append("is_primary",s);return(await u.post(`/products/${t}/images/upload`,a,{headers:{"Content-Type":"multipart/form-data"}})).data.image},generate:async(t,e,s="medium",a=1)=>(await u.post(`/products/${t}/images/generate`,{prompt:e,quality:s,count:a})).data.images},f={list:async(t,e={})=>(await u.get("/agent/tasks",{params:{company_id:t,...e}})).data,get:async t=>(await u.get(`/agent/tasks/${t}`)).data.task,create:async(t,e,s)=>(await u.post("/agent/tasks",{company_id:t,type:e,input_data:s})).data.task};function b(t,s){try{return e.$persist(t).as(s)}catch(a){return localStorage.removeItem("_x_"+s),localStorage.removeItem(s),t}}e.plugin(s);try{["auth_user","auth_token","current_company"].forEach(t=>{const e="_x_"+t,s=localStorage.getItem(e);if(s)try{JSON.parse(s)}catch(a){localStorage.removeItem(e),localStorage.removeItem(t)}})}catch(k){}window.api={...u,auth:p,companies:m,products:g,dialogs:w,chat:y,images:v,tasks:f,get:u.get,post:u.post,delete:u.delete},e.store("auth",{user:b(null,"auth_user"),token:b(null,"auth_token"),currentCompany:b(null,"current_company"),companies:[],showCompanyPrompt:!1,get isAuthenticated(){return!!this.token},get hasCompanies(){return this.companies.length>0},async login(t,e){const s=await p.login(t,e);return this.user=s.user,this.token=s.token,await this.loadCompanies(),s},async register(t){const e=await p.register(t);return this.user=e.user,this.token=e.token,await this.loadCompanies(),e},async loadCompanies(){try{if(this.companies=await m.list(),this.companies.length>0){if(!(this.currentCompany&&this.companies.some(t=>t.id===this.currentCompany.id))){const t=this.user?.company_id,e=t?this.companies.find(e=>e.id===t):null;this.currentCompany=e||this.companies[0]}this.showCompanyPrompt=!1}else this.showCompanyPrompt=!0,this.currentCompany=null;this.currentCompany&&await e.store("chat").loadDialogs(this.currentCompany.id)}catch(k){}},async logout(){await p.logout(),this.user=null,this.token=null,this.currentCompany=null,this.companies=[]},setCompany(t){this.currentCompany=t,t&&e.store("chat").loadDialogs(t.id)}}),e.store("chat",{dialogs:[],currentDialog:null,messages:[],loading:!1,async loadDialogs(t){try{const e=await w.list(t);this.dialogs=e.dialogs||[]}catch(k){this.dialogs=[]}},async loadDialog(t){this.loading=!0;const e=await w.get(t);this.currentDialog=e,this.messages=e.messages||[],this.loading=!1},async sendMessage(t,s={}){this.loading=!0;const a={message:t,mode:s.mode||"chat",model:s.model||"fast"};if(s.image_model&&(a.image_model=s.image_model),s.is_private&&(a.is_private=!0),this.currentDialog)a.dialog_id=this.currentDialog.id;else{const t=e.store("auth");a.company_id=t.currentCompany?.id}s.images?.length&&(a.images=s.images);const i={id:"temp-"+Date.now(),sender:"user",content:t,created_at:(new Date).toISOString()};this.messages.push(i);try{const t=await y.send(a);if(this.currentDialog){const e=this.dialogs.findIndex(e=>e.id===t.dialog.id);-1!==e&&(this.dialogs[e]=t.dialog)}else this.currentDialog=t.dialog,this.dialogs.unshift(t.dialog);const e=this.messages.findIndex(t=>t.id===i.id);return-1!==e&&(this.messages[e]=t.user_message),this.messages.push(t.assistant_message),this.loading=!1,t}catch(n){throw this.messages=this.messages.filter(t=>t.id!==i.id),this.loading=!1,n}},newChat(){this.currentDialog=null,this.messages=[]}}),e.store("products",{items:[],current:null,loading:!1,meta:{},async load(t,e={}){this.loading=!0;const s=await g.list(t,e);this.items=s.products,this.meta=s.meta,this.loading=!1},async get(t){return this.loading=!0,this.current=await g.get(t),this.loading=!1,this.current},async create(t){const e=await g.create(t);return this.items.unshift(e),e}}),window.Alpine=e,e.start();
