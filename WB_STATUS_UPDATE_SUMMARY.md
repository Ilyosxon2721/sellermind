# Исправление синхронизации статусов заказов Wildberries

## Проблема

На маркетплейсе было:
- 1 заказ со статусом "Новый"
- 2 заказа со статусом "На сборке"

В платформе отображалось:
- 32 заказа со статусом "Новый"

## Причина

Две основные проблемы в коде:

1. **Статус всегда устанавливался как "new"** (строка 376 в WildberriesOrderService.php)
   - Игнорировался правильно рассчитанный статус из `$wbStatusGroup`
   - Даже при обновлении существующих заказов статус всегда менялся на "new"

2. **Отменённые заказы оставались в базе**
   - Заказы, которых уже нет в API маркетплейса, продолжали отображаться
   - Не было механизма очистки старых заказов

## Решение

### Исправление 1: Использование правильного статуса

```php
// БЫЛО:
$order->fill([
    'status' => 'new',
    // ...
]);

// СТАЛО:
$order->fill([
    'status' => $wbStatusGroup,
    // ...
]);
```

**Файл:** `app/Services/Marketplaces/Wildberries/WildberriesOrderService.php:376`

### Исправление 2: Автоматическая отметка отменённых заказов

Добавлена логика для отслеживания синхронизированных заказов:

```php
$syncedOrderIds = []; // Собираем ID всех синхронизированных заказов

// В цикле обработки:
$syncedOrderIds[] = $orderData['id'];

// После синхронизации:
if (!empty($syncedOrderIds)) {
    MarketplaceOrder::where('marketplace_account_id', $account->id)
        ->whereNotIn('external_order_id', $syncedOrderIds)
        ->whereNotIn('status', ['archive', 'canceled'])
        ->update([
            'status' => 'canceled',
            'wb_status_group' => 'canceled',
        ]);
}
```

**Файл:** `app/Services/Marketplaces/Wildberries/WildberriesOrderService.php:139,170,187-201`

## Как проверить

### Вариант 1: Пересинхронизация с очисткой

```bash
# 1. Очистить все заказы WB
./clear-wb-orders.sh

# 2. В браузере запустить синхронизацию
# Нажать "Получить новые" на странице заказов WB

# 3. Проверить результат:
# - 1 заказ в "Новые"
# - 2 заказа в "На сборке"
```

### Вариант 2: Просто пересинхронизация

```bash
# 1. Проверить queue worker
ps aux | grep "queue:work"

# Если не запущен:
./restart-queue-worker.sh

# 2. В браузере запустить синхронизацию
# Нажать "Получить новые" на странице заказов WB

# 3. Результат:
# - Существующие заказы обновят свои статусы
# - Старые отменённые заказы переместятся во вкладку "Отменённые"
```

## Ожидаемый результат

После синхронизации:
- ✅ 1 заказ в статусе "Новые" (соответствует маркетплейсу)
- ✅ 2 заказа в статусе "На сборке" (соответствует маркетплейсу)
- ✅ ~29 заказов в статусе "Отменённые" (те, которых нет в API)
- ✅ Время в формате UTC+5 (Ташкент)
- ✅ Цены в рублях с копейками

## Технические детали

### mapWbStatusGroup()

Метод правильно определяет группу статуса:

- `new` → "Новые"
- `confirm`, `assembling` → "На сборке"
- `shipping`, `on_way_to_client` → "В доставке"
- `sold`, `delivered` → "Архив"
- `canceled` → "Отменённые"

Также учитывается `supplyId`:
- Если заказ прикреплён к поставке → автоматически "На сборке"

### fetchAllOrders()

Использует эндпоинт `/api/v3/orders` (без "new"):
- Получает ВСЕ активные заказы с маркетплейса
- Обновляет статусы существующих заказов
- Отмечает заказы, которых нет в ответе

## Дополнительные исправления

Ранее также были исправлены:
1. Временная зона (UTC+5)
2. Формат цен (деление на 100, округление)
3. Синхронизация всех заказов (не только новых)

См. подробности в `WB_SYNC_FIXES.md`
