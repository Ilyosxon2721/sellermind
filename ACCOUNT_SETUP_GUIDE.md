# Руководство по добавлению аккаунтов маркетплейсов

## Автоматическая валидация и тестирование

Система автоматически:
- ✅ Проверяет формат учётных данных
- ✅ Тестирует подключение к API маркетплейса
- ✅ Показывает понятные сообщения об ошибках на русском языке
- ✅ Автоматически отключает аккаунт при ошибке подключения

## API для получения требований к полям

**NEW!** Теперь доступен API endpoint для получения информации о полях формы:

```
GET /api/marketplace/accounts/requirements?marketplace={wb|uzum|ozon|ym}
```

### Пример использования:

```bash
curl -H "Authorization: Bearer YOUR_TOKEN" \
  "https://your-domain.com/api/marketplace/accounts/requirements?marketplace=wb"
```

### Структура ответа:

```json
{
  "marketplace": "wb",
  "name": "Wildberries",
  "description": "Для подключения к Wildberries необходимо создать API токен в личном кабинете",
  "setup_guide": {
    "title": "Как создать токен Wildberries?",
    "subtitle": "Рекомендуем создать один универсальный токен со всеми разделами - это проще и удобнее.",
    "link": "https://seller.wildberries.ru/supplier-settings/access-to-api",
    "link_text": "Открыть ЛК Wildberries",
    "tokens": [
      {
        "number": 1,
        "name": "Content API Token (Товары)",
        "field_name": "wb_content_token",
        "steps": ["ЛК WB → Настройки → Доступ к API → Создать токен"],
        "permissions": [
          "✓ Content → Карточки товаров (все права)",
          "✓ Nomenclature → Номенклатура"
        ]
      },
      {
        "number": 2,
        "name": "Marketplace API Token (Заказы)",
        "field_name": "wb_marketplace_token",
        "steps": ["ЛК WB → Настройки → Доступ к API → Создать токен"],
        "permissions": [
          "✓ Marketplace → Заказы, Поставки, Остатки",
          "✓ Warehouses → Склады (просмотр)"
        ]
      }
    ],
    "quick_tip": "Быстрая шпаргалка",
    "detailed_guide": "Подробная инструкция"
  },
  "fields": [
    {
      "name": "api_token",
      "label": "API токен (универсальный)",
      "type": "text",
      "required": false,
      "placeholder": "eyJhbGciOiJFUzI1NiIsImtpZCI6...",
      "help": "Универсальный токен с доступом ко всем API. Рекомендуется использовать этот вариант."
    }
  ],
  "instructions": {
    "title": "Где получить API токен Wildberries:",
    "steps": [
      "Войдите в личный кабинет Wildberries Seller",
      "Перейдите в раздел \"Настройки\" → \"Доступ к API\"",
      "..."
    ],
    "notes": [
      "Рекомендуется использовать универсальный токен для упрощения настройки",
      "..."
    ]
  },
  "validation": {
    "required_one_of": ["api_token", "wb_content_token", ...],
    "token_format": "base64",
    "min_length": 20
  }
}
```

### Использование на frontend:

Frontend может использовать этот endpoint для:

1. **Динамического отображения полей формы** - генерировать форму на основе данных API
2. **Показа подсказок пользователю** - отображать help text для каждого поля
3. **Отображения пошаговых инструкций** - показывать instructions.steps в модальном окне или сайдбаре
4. **Отображения setup guide с пронумерованными шагами** - использовать setup_guide для визуальных карточек с инструкциями
5. **Валидации формата полей** - использовать validation правила для проверки данных

### Пример React компонента:

```jsx
const [requirements, setRequirements] = useState(null);

useEffect(() => {
  if (selectedMarketplace) {
    fetch(`/api/marketplace/accounts/requirements?marketplace=${selectedMarketplace}`)
      .then(res => res.json())
      .then(data => setRequirements(data));
  }
}, [selectedMarketplace]);

return (
  <div>
    <h2>{requirements?.name}</h2>
    <p>{requirements?.description}</p>

    {requirements?.fields.map(field => (
      <div key={field.name}>
        <label>{field.label} {field.required && '*'}</label>
        <input
          type={field.type}
          name={field.name}
          placeholder={field.placeholder}
          required={field.required}
        />
        <small>{field.help}</small>
      </div>
    ))}

    <InstructionsModal steps={requirements?.instructions.steps} />
  </div>
);
```

---

## Wildberries

### Способ 1: Универсальный токен (рекомендуется)

```json
POST /api/marketplace/accounts
{
  "company_id": 1,
  "marketplace": "wb",
  "name": "Мой магазин WB",
  "credentials": {
    "api_token": "ваш_универсальный_токен_от_wildberries"
  }
}
```

### Способ 2: Отдельные токены для каждого API

```json
{
  "company_id": 1,
  "marketplace": "wb",
  "name": "Мой магазин WB",
  "credentials": {
    "wb_content_token": "токен_для_контента",
    "wb_marketplace_token": "токен_для_заказов",
    "wb_prices_token": "токен_для_цен",
    "wb_statistics_token": "токен_для_статистики"
  }
}
```

### Где получить токен:

1. Войдите в личный кабинет Wildberries Seller
2. Перейдите в раздел **Настройки → Доступ к API**
3. Нажмите **"Создать новый токен"**
4. Выберите необходимые разделы доступа:
   - ✅ **Контент** - для работы с товарами и медиа
   - ✅ **Маркетплейс** - для заказов и управления
   - ✅ **Поставки** - для работы с поставками
   - ✅ **Цены и скидки** - для управления ценами
   - ✅ **Статистика** - для получения статистики
   - ✅ **Аналитика** - для аналитических данных
   - ✅ **Финансы** - для финансовых данных (опционально)
   - ✅ **Возвраты** - для работы с возвратами
5. Нажмите **"Создать"** и скопируйте токен
6. ⚠️ **ВАЖНО:** Токен показывается только один раз! Сохраните его в безопасном месте.

### Возможные ошибки:

#### ❌ "API токен Wildberries недействителен или истёк"
**Решение:** Создайте новый токен в личном кабинете WB

#### ❌ "API токен не имеет необходимых прав доступа"
**Решение:** Проверьте права токена (должны быть включены все API)

#### ❌ "Токен имеет неправильный формат"
**Решение:** Убедитесь что скопировали весь токен полностью

---

## Uzum Market

### Формат запроса:

```json
POST /api/marketplace/accounts
{
  "company_id": 1,
  "marketplace": "uzum",
  "name": "Мой магазин Uzum",
  "credentials": {
    "api_token": "ваш_токен_от_uzum",
    "shop_ids": [12345, 67890]
  }
}
```

### Где получить данные:

1. Войдите в личный кабинет Uzum Market
2. Перейдите в раздел **Интеграции → API**
3. Создайте новый API токен
4. Найдите ID ваших магазинов в разделе **Магазины**

### Возможные ошибки:

#### ❌ "API токен не имеет доступа к указанным магазинам"
**Решение:**
- Проверьте что ID магазинов правильные
- Убедитесь что токен имеет доступ к этим магазинам
- Пересоздайте токен если нужно

#### ❌ "Необходимо указать ID магазинов (shop_ids)"
**Решение:** Добавьте массив shop_ids с ID ваших магазинов

---

## Ozon

### Формат запроса:

```json
POST /api/marketplace/accounts
{
  "company_id": 1,
  "marketplace": "ozon",
  "name": "Мой магазин Ozon",
  "credentials": {
    "client_id": "123456",
    "api_key": "ваш_api_ключ_от_ozon"
  }
}
```

### Где получить данные:

1. Войдите в личный кабинет Ozon Seller
2. Перейдите в **Настройки → API ключи**
3. Создайте новый ключ
4. Скопируйте Client ID и API Key

---

## Яндекс.Маркет

### Формат запроса:

```json
POST /api/marketplace/accounts
{
  "company_id": 1,
  "marketplace": "ym",
  "name": "Мой магазин на Яндекс.Маркет",
  "credentials": {
    "oauth_token": "ваш_oauth_токен",
    "campaign_id": "12345678"
  }
}
```

### Где получить данные:

1. Войдите в личный кабинет Яндекс.Маркет
2. Перейдите в **Настройки → API**
3. Получите OAuth токен
4. Найдите ID кампании в настройках магазина

---

## Примеры ответов API

### ✅ Успешное подключение:

```json
{
  "message": "Маркетплейс успешно подключён! Подключение к Wildberries API успешно проверено.",
  "account": {
    "id": 3,
    "marketplace": "wb",
    "name": "Мой магазин WB",
    "is_active": true,
    "connected_at": "2025-12-15T10:30:00.000000Z"
  },
  "test_result": {
    "success": true,
    "message": "Подключение к Wildberries API успешно проверено.",
    "details": "Найдено поставок: 5"
  }
}
```

### ❌ Ошибка при подключении:

```json
{
  "message": "Аккаунт создан, но подключение не удалось",
  "error": "API токен Wildberries недействителен или истёк. Получите новый токен в личном кабинете WB.",
  "account": {
    "id": 3,
    "marketplace": "wb",
    "name": "Мой магазин WB",
    "is_active": false,
    "connected_at": "2025-12-15T10:30:00.000000Z"
  },
  "warning": "Проверьте правильность API токенов. Аккаунт отключён до успешного подключения."
}
```

### ❌ Ошибка валидации:

```json
{
  "message": "Ошибка в учётных данных",
  "error": "Для Wildberries необходимо указать хотя бы один API токен."
}
```

---

## Обновление учётных данных существующего аккаунта

```json
POST /api/marketplace/accounts
{
  "account_id": 3,
  "company_id": 1,
  "marketplace": "wb",
  "name": "Новое название (опционально)",
  "credentials": {
    "api_token": "новый_токен"
  }
}
```

Система автоматически:
1. ✅ Проверит формат нового токена
2. ✅ Протестирует подключение к API
3. ✅ Обновит данные только если тест успешен
4. ✅ Отключит аккаунт если тест не прошёл

---

## Диагностика проблем

### Если аккаунт не активен после добавления:

1. Проверьте ответ API - в нём будет описание ошибки
2. Убедитесь что токен правильный и актуальный
3. Проверьте права токена в личном кабинете маркетплейса
4. Попробуйте обновить учётные данные через `account_id`

### Если синхронизация не работает:

1. Убедитесь что аккаунт активен (`is_active: true`)
2. Проверьте логи: `GET /api/marketplace/accounts/{account}/logs`
3. Запустите тестовый запрос: `POST /api/marketplace/accounts/{account}/test`

---

## Множественные аккаунты

Вы можете добавить **несколько аккаунтов одного маркетплейса**!

Например:
- WB - Магазин 1
- WB - Магазин 2
- WB - Склад в Москве
- WB - Склад в Казани

Каждый аккаунт работает независимо со своими заказами, товарами и поставками.

---

## Техническая поддержка

При возникновении проблем обратитесь в поддержку, предоставив:
- ID аккаунта
- Название маркетплейса
- Текст ошибки из ответа API
- Скриншот настроек токена из личного кабинета маркетплейса
